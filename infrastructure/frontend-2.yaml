AWSTemplateFormatVersion: '2010-09-09'
Description: Pila del servidor para el frontend nÂº2

Parameters:

  InstanceType:
    Description: Parametro para seleccionar el tipo de instancia EC2
    Type: String
    Default: t2.small
    AllowedValues:
      - t2.large
      - t2.medium
      - t2.small
      - t2.micro
      - t2.nano

  InstanceImage:
    Description: Parametro para seleccionar la AMI Ubuntu 22.04
    Type: String
    Default: "ami-0f9de6e2d2f067fca"
  
  InstanceKeyName:
    Description: Parametro para seleccionar el KeyName de la Instancia
    Type: String
    Default: "vockey"
  
  HostedZoneName:
    Type: String
    Description: Nombre del dominio para la zona hospedada en Route 53
    Default: "chefmate"


Resources:

  FrontendDNS:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      HostedZoneId:
        Fn::ImportValue: "HostedZone"
          
      RecordSets:
        - Name: !Sub "fe2.${HostedZoneName}."
          Type: A
          TTL: '900'
          ResourceRecords:
            - !GetAtt Frontend.PrivateIp

  Frontend:
    Type: "AWS::EC2::Instance"
    Description: Servidor del Frontend
    Properties:
      Tags:
        - Key: "Name"
          Value: "fe2"
      ImageId: !Ref InstanceImage
      InstanceType: !Ref InstanceType 
      KeyName: !Ref InstanceKeyName
      SecurityGroupIds: 
        - Fn::ImportValue:
            !Sub "http-sg"
        - Fn::ImportValue:
            !Sub "ssh-sg"
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          exec > /tmp/userdata.log 2>&1

          #====================================================================#
          #----------------------> PREPARAR SERVIDOR <-------------------------#
          #====================================================================#

          # Actualizar la lista de paquetes de la instancia
          apt update 
          apt upgrade -y

          # Instalar git y curl
          apt install -y git unzip curl

          # Instalar docker y habilitarlo
          apt-get install  curl apt-transport-https ca-certificates software-properties-common -y
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
          add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
          apt update 
          apt install docker-ce -y
          systemctl enable docker
          systemctl start docker

          # Clonar repositorio de ChefMate
          cd /home/ubuntu
          git clone https://FranciscoCabelloRueda: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@github.com/FranciscoCabelloRueda/ChefMate.git chefmate
          chown -R ubuntu:ubuntu /home/ubuntu/chefmate

          #====================================================================#
          #----------------------> LANZAR CONTENEDOR <-------------------------#
          #====================================================================#

          cd /home/ubuntu/chefmate/angular-frontend
          docker build -t angular-prod .

          docker run -d \
            --name angular-prod \
            -p 80:80 \
            angular-prod

Outputs:

  Frontend:
    Value: !GetAtt Frontend.PrivateIp
    Export:
      Name: fe2